#!/usr/bin/env python3
# This file is placed in the Public Domain.
#
# pylint: disable=C0114,C0115,C0116,W0703,C0209,C0301,R1732


import os
import subprocess
import sys
import time


NAME = "sbn"


os.environ["PATH"] += ":bin"


def popen2(txt):
    runtxt = "\n## " + txt +"\n"
    print(runtxt)
    for line in os.popen(txt).readlines():
        print(line.rstrip())
        sys.stdout.flush()


def popen(txt):
    print("\n" + txt +"\n")
    proc = subprocess.Popen(
                            txt.split(),
                            stdin=sys.stdin,
                            stdout=sys.stdout,
                            stderr=sys.stderr,
                            close_fds=False,
                            text=True
                           )
    proc.communicate()
    proc.wait()


def main():
    print("ALL started at %s" % time.ctime(time.time()).replace("  ", " "))
    popen("clean")
    popen("lint")
    #popen("python3 -m pylama --skip env/*")
    popen("python3 -m pytest --doctest-modules")
    popen("build")
    popen("python3 -mvirtualenv --system-site-packages env")
    popen("env/bin/python3 -m pip  install %s -f dist --upgrade --force-reinstall --no-cache-dir" % NAME)
    popen("env/bin/%s cmd" % NAME)
    popen("twine check dist/*")

if __name__ == "__main__":
    main()
